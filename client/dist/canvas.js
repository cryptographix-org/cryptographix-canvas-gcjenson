var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
define(["require", "exports", 'aurelia-framework', 'aurelia-dialog', './link-config-dialog', './add-node-dialog', 'cryptographix-sim-core', './animation'], function (require, exports, aurelia_framework_1, aurelia_dialog_1, link_config_dialog_1, add_node_dialog_1, cryptographix_sim_core_1, animation_1) {
    var Canvas = (function () {
        function Canvas(taskQueue, dialogService) {
            this.nodes = [];
            this.isDragging = false;
            this.nodeStyle = "regular";
            this.taskQueue = taskQueue;
            this.dialogService = dialogService;
        }
        Canvas.prototype.attached = function () {
            var _this = this;
            this.network.loadComponents().then(function () {
                _this.network.initialize();
                _this.network.graph.nodes.forEach(function (node) {
                    _this.nodes.push(node);
                });
                _this.taskQueue.queueMicroTask({
                    call: function () { return _this.setUpGraphUI(); }
                });
            });
        };
        Canvas.prototype.detached = function () {
            this.unregisterEvents();
            jsPlumb.detachEveryConnection();
            this.removeGraph(this.network.graph);
            this.nodes = [];
        };
        Canvas.prototype.setUpGraphUI = function () {
            for (var _i = 0, _a = this.nodes; _i < _a.length; _i++) {
                var node = _a[_i];
                this.configureDomElement(node);
                this.addPortsToNode(node);
            }
            this.connectNodes(this.network.graph.links);
            this.registerEvents();
        };
        Canvas.prototype.zoom = function (node) {
            if (!this.isDragging) {
                if (!this.isZoomedIn(node)) {
                    animation_1.Animation.zoomIn(node, this.nodes, 3);
                }
                else {
                    animation_1.Animation.zoomOut(this.nodes);
                }
            }
            this.isDragging = false;
        };
        Canvas.prototype.configureDomElement = function (node) {
            var nodeElement = document.getElementById(node.id);
            nodeElement.style.left = parseInt(node.metadata.view.x) + "px";
            nodeElement.style.top = parseInt(node.metadata.view.y) + "px";
            nodeElement.style.width = parseInt(node.metadata.view.width) + "px";
            nodeElement.style.height = parseInt(node.metadata.view.height) + "px";
            var self = this;
            jsPlumb.draggable(node.id, {
                stop: function (e) {
                    node.metadata.view.x = e.pos[0];
                    node.metadata.view.y = e.pos[1];
                    self.isDragging = true;
                }
            });
        };
        Canvas.prototype.addPortsToNode = function (node) {
            var portsArray = this.sortPorts(node.ports);
            for (var _i = 0, _a = [portsArray[0], portsArray[1], portsArray[2]]; _i < _a.length; _i++) {
                var portArray = _a[_i];
                if (portArray.length > 0) {
                    for (var j = 0; j < portArray.length; j++) {
                        if (portArray[0].direction === cryptographix_sim_core_1.Direction.INOUT) {
                            var x = (1 / (portArray.length + 1)) + ((1 / (portArray.length + 1)) * j);
                            var y = 0;
                        }
                        else {
                            var x = portArray[0].direction - 1;
                            var y = (1 / (portArray.length + 1)) + ((1 / (portArray.length + 1)) * j);
                        }
                        jsPlumb.addEndpoint(node.id, {
                            uuid: node.id + "-" + portArray[j].id,
                            anchors: [[x, y]],
                            isSource: portArray[0].direction === cryptographix_sim_core_1.Direction.OUT,
                            isTarget: portArray[0].direction === cryptographix_sim_core_1.Direction.IN,
                            maxConnections: -1,
                            paintStyle: { fillStyle: "#77aca7", radius: 4 },
                            hoverPaintStyle: { fillStyle: "#77aca7", radius: 8 },
                            connectorStyle: { strokeStyle: "#77aca7", lineWidth: 4 },
                            connectorHoverStyle: { lineWidth: 8 }
                        });
                    }
                }
            }
        };
        Canvas.prototype.connectNodes = function (links) {
            links.forEach(function (link) {
                jsPlumb.connect({
                    uuids: [link.fromNode.id + "-" + link.fromPort.id, link.toNode.id + "-" + link.toPort.id],
                    endpointStyle: { fillStyle: "#77aca7", radius: 4 },
                    hoverPaintStyle: { radius: 8 },
                    paintStyle: { strokeStyle: "#77aca7", lineWidth: 4 }
                }).id = link.toObject()["id"];
            });
        };
        Canvas.prototype.registerEvents = function () {
            var self = this;
            jsPlumb.bind("connection", function (data) {
                if (self.isNewConnection(data.connection.id))
                    self.createLink(data.connection.endpoints[0].getUuid(), data.connection.endpoints[1].getUuid(), undefined);
            });
            jsPlumb.bind("connectionDetached", function (data) {
                self.removeLink(data.connection.id);
            });
            jsPlumb.bind("connectionMoved", function (data) {
                self.changeLink(data);
            });
        };
        Canvas.prototype.unregisterEvents = function () {
            jsPlumb.unbind("connection");
            jsPlumb.unbind("connectionDetached");
            jsPlumb.unbind("connectionMoved");
        };
        Canvas.prototype.sortPorts = function (ports) {
            var inOutPorts = [];
            var inPorts = [];
            var outPorts = [];
            ports.forEach(function (port) {
                if (port.direction === cryptographix_sim_core_1.Direction.INOUT) {
                    inOutPorts.push(port);
                }
                else if (port.direction === cryptographix_sim_core_1.Direction.IN) {
                    inPorts.push(port);
                }
                else {
                    outPorts.push(port);
                }
            });
            return [inOutPorts, inPorts, outPorts];
        };
        Canvas.prototype.removeGraph = function (graph) {
            graph.nodes.forEach(function (node) {
                jsPlumb.remove(node.id);
            });
        };
        Canvas.prototype.addNode = function () {
            this.dialogService.open({ viewModel: add_node_dialog_1.AddNodeDialog }).then(function (response) {
            });
        };
        Canvas.prototype.createLink = function (sourceEndPointID, targetEndPointID, linkID) {
            var _this = this;
            if (!linkID) {
                this.dialogService.open({ viewModel: link_config_dialog_1.LinkConfigDialog }).then(function (response) {
                    if (!response.wasCancelled) {
                        jsPlumb.getConnections()[jsPlumb.getConnections().length - 1].id = response.output;
                        _this.network.graph.addLink(response.output, {
                            from: { nodeID: sourceEndPointID.split("-")[0], portID: sourceEndPointID.split("-")[1] },
                            to: { nodeID: targetEndPointID.split("-")[0], portID: targetEndPointID.split("-")[1] }
                        });
                    }
                    else {
                        var connections = jsPlumb.getConnections();
                        jsPlumb.detach(connections[connections.length - 1]);
                    }
                });
            }
            else {
                this.network.graph.addLink(linkID, {
                    from: { nodeID: sourceEndPointID.split("-")[0], portID: sourceEndPointID.split("-")[1] },
                    to: { nodeID: targetEndPointID.split("-")[0], portID: targetEndPointID.split("-")[1] }
                });
            }
        };
        Canvas.prototype.removeLink = function (linkID) {
            this.network.graph.removeLink(linkID);
        };
        Canvas.prototype.changeLink = function (data) {
            this.removeLink(data.connection.id);
            this.createLink(data.originalSourceEndpoint.getUuid(), data.newTargetEndpoint.getUuid(), data.connection.id);
        };
        Canvas.prototype.isNewConnection = function (linkID) {
            var isNew;
            this.network.graph.links.forEach(function (link) {
                isNew = link.toObject()["id"] !== linkID;
            });
            return isNew;
        };
        Canvas.prototype.isZoomedIn = function (node) {
            return document.getElementById(node.id).style.width !== node.metadata.view.width;
        };
        Canvas = __decorate([
            aurelia_framework_1.autoinject,
            aurelia_framework_1.containerless(),
            aurelia_framework_1.customElement('canvas'),
            aurelia_framework_1.bindable('network'), 
            __metadata('design:paramtypes', [aurelia_framework_1.TaskQueue, aurelia_dialog_1.DialogService])
        ], Canvas);
        return Canvas;
    })();
    exports.Canvas = Canvas;
});

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhbnZhcy50cyJdLCJuYW1lcyI6WyJDYW52YXMiLCJDYW52YXMuY29uc3RydWN0b3IiLCJDYW52YXMuYXR0YWNoZWQiLCJDYW52YXMuZGV0YWNoZWQiLCJDYW52YXMuc2V0VXBHcmFwaFVJIiwiQ2FudmFzLnpvb20iLCJDYW52YXMuY29uZmlndXJlRG9tRWxlbWVudCIsIkNhbnZhcy5hZGRQb3J0c1RvTm9kZSIsIkNhbnZhcy5jb25uZWN0Tm9kZXMiLCJDYW52YXMucmVnaXN0ZXJFdmVudHMiLCJDYW52YXMudW5yZWdpc3RlckV2ZW50cyIsIkNhbnZhcy5zb3J0UG9ydHMiLCJDYW52YXMucmVtb3ZlR3JhcGgiLCJDYW52YXMuYWRkTm9kZSIsIkNhbnZhcy5jcmVhdGVMaW5rIiwiQ2FudmFzLnJlbW92ZUxpbmsiLCJDYW52YXMuY2hhbmdlTGluayIsIkNhbnZhcy5pc05ld0Nvbm5lY3Rpb24iLCJDYW52YXMuaXNab29tZWRJbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztJQU9BO1FBYUVBLGdCQUFZQSxTQUFvQkEsRUFBRUEsYUFBNEJBO1lBTnREQyxVQUFLQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUdYQSxlQUFVQSxHQUFHQSxLQUFLQSxDQUFDQTtZQUNuQkEsY0FBU0EsR0FBR0EsU0FBU0EsQ0FBQ0E7WUFHNUJBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLFNBQVNBLENBQUNBO1lBQzNCQSxJQUFJQSxDQUFDQSxhQUFhQSxHQUFHQSxhQUFhQSxDQUFBQTtRQUNwQ0EsQ0FBQ0E7UUFFREQseUJBQVFBLEdBQVJBO1lBQUFFLGlCQWNDQTtZQVpDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxjQUFjQSxFQUFFQSxDQUFDQSxJQUFJQSxDQUFDQTtnQkFDakNBLEtBQUlBLENBQUNBLE9BQU9BLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBO2dCQUUxQkEsS0FBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFB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LENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLFNBQVNBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO3dCQUMxQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsU0FBU0EsS0FBS0Esa0NBQVNBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBOzRCQUMvQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7NEJBQzFFQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTt3QkFDWkEsQ0FBQ0E7d0JBQUNBLElBQUlBLENBQUNBLENBQUNBOzRCQUNOQSxJQUFJQSxDQUFDQSxHQUFHQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxTQUFTQSxHQUFHQSxDQUFDQSxDQUFDQTs0QkFDbkNBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLFNBQVNBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLFNBQVNBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO3dCQUM1RUEsQ0FBQ0E7d0JBRURBLE9BQU9BLENBQUNBLFdBQVdBLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLEVBQUVBOzRCQUUzQkEsSUFBSUEsRUFBRUEsSUFBSUEsQ0FBQ0EsRUFBRUEsR0FBR0EsR0FBR0EsR0FBR0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsRUFBRUE7NEJBQ3JD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QUFDQSw4QkFBVUE7WUFDVkEsaUNBQWFBLEVBQUVBO1lBQ2ZBLGlDQUFhQSxDQUFDQSxRQUFRQSxDQUFDQTtZQUN2QkEsNEJBQVFBLENBQUNBLFNBQVNBLENBQUNBOzttQkF5T25CQTtRQUFEQSxhQUFDQTtJQUFEQSxDQTVPQSxBQTRPQ0EsSUFBQTtJQXhPWSxjQUFNLFNBd09sQixDQUFBIiwiZmlsZSI6ImNhbnZhcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7YXV0b2luamVjdCwgY3VzdG9tRWxlbWVudCwgYmluZGFibGUsIGNvbnRhaW5lcmxlc3MsIFRhc2tRdWV1ZX0gZnJvbSAnYXVyZWxpYS1mcmFtZXdvcmsnO1xuaW1wb3J0IHtEaWFsb2dTZXJ2aWNlfSBmcm9tICdhdXJlbGlhLWRpYWxvZyc7XG5pbXBvcnQge0xpbmtDb25maWdEaWFsb2d9IGZyb20gJy4vbGluay1jb25maWctZGlhbG9nJztcbmltcG9ydCB7QWRkTm9kZURpYWxvZ30gZnJvbSAnLi9hZGQtbm9kZS1kaWFsb2cnO1xuaW1wb3J0IHtOZXR3b3JrLCBOb2RlLCBMaW5rLCBEaXJlY3Rpb259IGZyb20gJ2NyeXB0b2dyYXBoaXgtc2ltLWNvcmUnO1xuaW1wb3J0IHtBbmltYXRpb259IGZyb20gJy4vYW5pbWF0aW9uJztcblxuQGF1dG9pbmplY3RcbkBjb250YWluZXJsZXNzKClcbkBjdXN0b21FbGVtZW50KCdjYW52YXMnKVxuQGJpbmRhYmxlKCduZXR3b3JrJylcbmV4cG9ydCBjbGFzcyBDYW52YXMgeyBcblxuICBwcml2YXRlIG5ldHdvcms6IE5ldHdvcms7XG4gIHByaXZhdGUgbm9kZXMgPSBbXTtcbiAgcHJpdmF0ZSB0YXNrUXVldWU6IFRhc2tRdWV1ZTtcbiAgcHJpdmF0ZSBkaWFsb2dTZXJ2aWNlOiBEaWFsb2dTZXJ2aWNlO1xuICBwcml2YXRlIGlzRHJhZ2dpbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSBub2RlU3R5bGUgPSBcInJlZ3VsYXJcIjtcblxuICBjb25zdHJ1Y3Rvcih0YXNrUXVldWU6IFRhc2tRdWV1ZSwgZGlhbG9nU2VydmljZTogRGlhbG9nU2VydmljZSkge1xuICAgIHRoaXMudGFza1F1ZXVlID0gdGFza1F1ZXVlO1xuICAgIHRoaXMuZGlhbG9nU2VydmljZSA9IGRpYWxvZ1NlcnZpY2VcbiAgfVxuXG4gIGF0dGFjaGVkKCkge1xuICAgIC8vIHRoZSBuZXR3b3JrIG9iamVjdCBoYXMgYmVlbiBib3VuZCB0byBjYW52YXMgaW4gdGhlIHZpZXdcbiAgICB0aGlzLm5ldHdvcmsubG9hZENvbXBvbmVudHMoKS50aGVuKCgpID0+IHtcbiAgICAgIHRoaXMubmV0d29yay5pbml0aWFsaXplKCk7ICBcblxuICAgICAgdGhpcy5uZXR3b3JrLmdyYXBoLm5vZGVzLmZvckVhY2gobm9kZSA9PiB7XG4gICAgICAgIHRoaXMubm9kZXMucHVzaChub2RlKTtcbiAgICAgIH0pO1xuXG4gICAgICAvLyBtaWNyb3Rhc2sgZW5zdXJlcyB0aGUgd29yayBpcyBub3QgZG9uZSB1bnRpbCBlYWNoIG5vZGUgaGFzIGF0dGFjaGVkIHRvIHRoZSB2aWV3XG4gICAgICB0aGlzLnRhc2tRdWV1ZS5xdWV1ZU1pY3JvVGFzayh7XG4gICAgICAgIGNhbGw6ICgpID0+IHRoaXMuc2V0VXBHcmFwaFVJKClcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLy8ganNQbHVtYiBzdHVmZiBpcyByZW1vdmVkIGJlZm9yZSBjaGFuZ2luZyB2aWV3c1xuICBkZXRhY2hlZCgpIHtcbiAgICB0aGlzLnVucmVnaXN0ZXJFdmVudHMoKTtcbiAgICBqc1BsdW1iLmRldGFjaEV2ZXJ5Q29ubmVjdGlvbigpO1xuICAgIHRoaXMucmVtb3ZlR3JhcGgodGhpcy5uZXR3b3JrLmdyYXBoKTtcbiAgICB0aGlzLm5vZGVzID0gW107XG4gIH1cblxuICBzZXRVcEdyYXBoVUkoKSB7XG4gICAgZm9yIChsZXQgbm9kZSBvZiB0aGlzLm5vZGVzKSB7XG4gICAgICB0aGlzLmNvbmZpZ3VyZURvbUVsZW1lbnQobm9kZSk7XG4gICAgICB0aGlzLmFkZFBvcnRzVG9Ob2RlKG5vZGUpO1xuICAgIH1cbiAgICB0aGlzLmNvbm5lY3ROb2Rlcyh0aGlzLm5ldHdvcmsuZ3JhcGgubGlua3MpOyBcbiAgICB0aGlzLnJlZ2lzdGVyRXZlbnRzKCk7XG4gIH1cblxuICB6b29tKG5vZGU6IE5vZGUpIHtcbiAgICAvLyBjaGVjayB0byBwcmV2ZW50IGRyYWdnaW5nIGV2ZW50IGZyb20gY2F1c2luZyBhIHpvb21cbiAgICBpZiAoIXRoaXMuaXNEcmFnZ2luZykge1xuICAgICAgaWYgKCF0aGlzLmlzWm9vbWVkSW4obm9kZSkpIHtcbiAgICAgICAgQW5pbWF0aW9uLnpvb21Jbihub2RlLCB0aGlzLm5vZGVzLCAzKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIEFuaW1hdGlvbi56b29tT3V0KHRoaXMubm9kZXMpO1xuICAgICAgfVxuICAgIH1cbiAgICB0aGlzLmlzRHJhZ2dpbmcgPSBmYWxzZTtcbiAgfVxuXG5cbiAgY29uZmlndXJlRG9tRWxlbWVudChub2RlOiBOb2RlKSB7XG4gICAgbGV0IG5vZGVFbGVtZW50ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobm9kZS5pZCk7XG4gICAgbm9kZUVsZW1lbnQuc3R5bGUubGVmdCA9IHBhcnNlSW50KG5vZGUubWV0YWRhdGEudmlldy54KSArIFwicHhcIjtcbiAgICBub2RlRWxlbWVudC5zdHlsZS50b3AgPSBwYXJzZUludChub2RlLm1ldGFkYXRhLnZpZXcueSkgKyBcInB4XCI7XG4gICAgbm9kZUVsZW1lbnQuc3R5bGUud2lkdGggPSBwYXJzZUludChub2RlLm1ldGFkYXRhLnZpZXcud2lkdGgpICsgXCJweFwiO1xuICAgIG5vZGVFbGVtZW50LnN0eWxlLmhlaWdodCA9IHBhcnNlSW50KG5vZGUubWV0YWRhdGEudmlldy5oZWlnaHQpICsgXCJweFwiO1xuXG4gICAgdmFyIHNlbGYgPSB0aGlzO1xuICAgIGpzUGx1bWIuZHJhZ2dhYmxlKG5vZGUuaWQsIHtcbiAgICAgIHN0b3A6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgbm9kZS5tZXRhZGF0YS52aWV3LnggPSBlLnBvc1swXTsgICAgXG4gICAgICAgIG5vZGUubWV0YWRhdGEudmlldy55ID0gZS5wb3NbMV07XG4gICAgICAgIHNlbGYuaXNEcmFnZ2luZyA9IHRydWU7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIGFkZFBvcnRzVG9Ob2RlKG5vZGU6IE5vZGUpIHtcbiAgICB2YXIgcG9ydHNBcnJheSA9IHRoaXMuc29ydFBvcnRzKG5vZGUucG9ydHMpO1xuXG4gICAgLy8gZG8gZXZlcnl0aGluZyBmb3IgdGhlIGlub3V0LCBpbiBhbmQgb3V0IHBvcnRzIHJlc3BlY3RpdmVseVxuICAgIGZvciAobGV0IHBvcnRBcnJheSBvZiBbcG9ydHNBcnJheVswXSwgcG9ydHNBcnJheVsxXSwgcG9ydHNBcnJheVsyXV0pIHtcbiAgICAgIGlmIChwb3J0QXJyYXkubGVuZ3RoID4gMCkge1xuICAgICAgXG4gICAgICAgIC8qIFxuICAgICAgICAgKiBwb3J0cyBhcmUgc3BhY2VkIG91dCBldmVubHkgb24gdGhlIG5vZGUsIGRlcGVuZGluZyBvbiB0aGUgbnVtYmVyIG9mIHRoZW1cbiAgICAgICAgICogSU5PVVQgLSB0b3Agb2Ygbm9kZVxuICAgICAgICAgKiBJTiAtIGxlZnQgb2Ygbm9kZVxuICAgICAgICAgKiBPVVQgLSByaWdodCBvZiBub2RlXG4gICAgICAgICAqL1xuICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHBvcnRBcnJheS5sZW5ndGg7IGorKykge1xuICAgICAgICAgIGlmIChwb3J0QXJyYXlbMF0uZGlyZWN0aW9uID09PSBEaXJlY3Rpb24uSU5PVVQpIHtcbiAgICAgICAgICAgIHZhciB4ID0gKDEgLyAocG9ydEFycmF5Lmxlbmd0aCArIDEpKSArICgoMSAvIChwb3J0QXJyYXkubGVuZ3RoICsgMSkpICogaik7ICAgICAgICAgICAgXG4gICAgICAgICAgICB2YXIgeSA9IDA7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciB4ID0gcG9ydEFycmF5WzBdLmRpcmVjdGlvbiAtIDE7XG4gICAgICAgICAgICB2YXIgeSA9ICgxIC8gKHBvcnRBcnJheS5sZW5ndGggKyAxKSkgKyAoKDEgLyAocG9ydEFycmF5Lmxlbmd0aCArIDEpKSAqIGopO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGpzUGx1bWIuYWRkRW5kcG9pbnQobm9kZS5pZCwge1xuICAgICAgICAgICAgLy8gaWQncyBhcmUgY29tYmluZWQgc28gY29ubmVjdGlvbnMgY2FuIGJlIGRyYXduIGZyb20gc3BlY2lmaWMgcG9ydHMgb24gc3BlY2lmaWMgbm9kZXNcbiAgICAgICAgICAgIHV1aWQ6IG5vZGUuaWQgKyBcIi1cIiArIHBvcnRBcnJheVtqXS5pZCxcbiAgICAgICAgICAgIGFuY2hvcnM6IFtbeCwgeV1dLFxuICAgICAgICAgICAgaXNTb3VyY2U6IHBvcnRBcnJheVswXS5kaXJlY3Rpb24gPT09IERpcmVjdGlvbi5PVVQsXG4gICAgICAgICAgICBpc1RhcmdldDpwb3J0QXJyYXlbMF0uZGlyZWN0aW9uID09PSBEaXJlY3Rpb24uSU4sICAgICAgICAgICBcbiAgICAgICAgICAgIG1heENvbm5lY3Rpb25zOiAtMSwgLy8gbm8gbGltaXRcbiAgICAgICAgICAgIHBhaW50U3R5bGU6IHsgZmlsbFN0eWxlOiBcIiM3N2FjYTdcIiwgcmFkaXVzOiA0IH0sXG4gICAgICAgICAgICBob3ZlclBhaW50U3R5bGU6IHsgZmlsbFN0eWxlOiBcIiM3N2FjYTdcIiwgcmFkaXVzOiA4IH0sXG4gICAgICAgICAgICBjb25uZWN0b3JTdHlsZTogeyBzdHJva2VTdHlsZTogXCIjNzdhY2E3XCIsIGxpbmVXaWR0aDogNCB9LFxuICAgICAgICAgICAgY29ubmVjdG9ySG92ZXJTdHlsZTogeyBsaW5lV2lkdGg6IDggfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb25uZWN0Tm9kZXMobGlua3M6IE1hcDxzdHJpbmcsIExpbms+KSB7XG4gICAgbGlua3MuZm9yRWFjaChmdW5jdGlvbihsaW5rKSB7XG4gICAgICAoanNQbHVtYi5jb25uZWN0KHtcbiAgICAgICAgdXVpZHM6IFtsaW5rLmZyb21Ob2RlLmlkICsgXCItXCIgKyBsaW5rLmZyb21Qb3J0LmlkLCBsaW5rLnRvTm9kZS5pZCArIFwiLVwiICsgbGluay50b1BvcnQuaWRdLFxuICAgICAgICBlbmRwb2ludFN0eWxlOiB7IGZpbGxTdHlsZTogXCIjNzdhY2E3XCIsIHJhZGl1czogNCB9LFxuICAgICAgICBob3ZlclBhaW50U3R5bGU6IHsgcmFkaXVzOiA4IH0sXG4gICAgICAgIHBhaW50U3R5bGU6IHsgc3Ryb2tlU3R5bGU6IFwiIzc3YWNhN1wiLCBsaW5lV2lkdGg6IDQgfVxuICAgICAgfSkgYXMgYW55KS5pZCA9IGxpbmsudG9PYmplY3QoKVtcImlkXCJdOyBcbiAgICAgIC8vIGNvbm5lY3Rpb24gaXMgY2FzdCB0byBhbnksIGJlY2F1c2UganNQbHVtYiB0eXBlc2NyaXB0IGRlZmluaXRpb25zIGRvbid0IGluY2x1ZGUgLmlkIGZvciBzb21lIHJlYXNvbiAgICAgXG4gICAgfSk7XG4gIH1cblxuICByZWdpc3RlckV2ZW50cygpIHtcbiAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgXG4gICAganNQbHVtYi5iaW5kKFwiY29ubmVjdGlvblwiLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAvLyBjaGVjayB0byBkZWFsIHdpdGggYW4gaWRpb3N5bmNyYXN5IG9mIGpzUGx1bWIgd2hlcmUgJ2Nvbm5lY3Rpb24nIGdldHMgZmlyZWQgYXMgd2VsbCBhcyAnY29ubmVjdGlvbk1vdmVkJ1xuICAgICAgaWYgKHNlbGYuaXNOZXdDb25uZWN0aW9uKGRhdGEuY29ubmVjdGlvbi5pZCkpXG4gICAgICAgIHNlbGYuY3JlYXRlTGluayhkYXRhLmNvbm5lY3Rpb24uZW5kcG9pbnRzWzBdLmdldFV1aWQoKSwgZGF0YS5jb25uZWN0aW9uLmVuZHBvaW50c1sxXS5nZXRVdWlkKCksIHVuZGVmaW5lZCk7XG4gICAgfSk7XG5cbiAgICBqc1BsdW1iLmJpbmQoXCJjb25uZWN0aW9uRGV0YWNoZWRcIiwgZnVuY3Rpb24oZGF0YSkgeyBcbiAgICAgIHNlbGYucmVtb3ZlTGluayhkYXRhLmNvbm5lY3Rpb24uaWQpO1xuICAgIH0pO1xuXG4gICAganNQbHVtYi5iaW5kKFwiY29ubmVjdGlvbk1vdmVkXCIsIGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgIHNlbGYuY2hhbmdlTGluayhkYXRhKTtcbiAgICB9KTtcbiAgfVxuXG4gIHVucmVnaXN0ZXJFdmVudHMoKSB7XG4gICAganNQbHVtYi51bmJpbmQoXCJjb25uZWN0aW9uXCIpO1xuICAgIGpzUGx1bWIudW5iaW5kKFwiY29ubmVjdGlvbkRldGFjaGVkXCIpO1xuICAgIGpzUGx1bWIudW5iaW5kKFwiY29ubmVjdGlvbk1vdmVkXCIpO1xuICB9XG5cbiAgc29ydFBvcnRzKHBvcnRzOiBhbnkpIHtcbiAgICB2YXIgaW5PdXRQb3J0cyA9IFtdO1xuICAgIHZhciBpblBvcnRzID0gW107XG4gICAgdmFyIG91dFBvcnRzID0gW107XG5cbiAgICBwb3J0cy5mb3JFYWNoKGZ1bmN0aW9uKHBvcnQpIHtcbiAgICAgIGlmIChwb3J0LmRpcmVjdGlvbiA9PT0gRGlyZWN0aW9uLklOT1VUKSB7XG4gICAgICAgIGluT3V0UG9ydHMucHVzaChwb3J0KTtcbiAgICAgIH0gZWxzZSBpZiAocG9ydC5kaXJlY3Rpb24gPT09IERpcmVjdGlvbi5JTikge1xuICAgICAgICBpblBvcnRzLnB1c2gocG9ydCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvdXRQb3J0cy5wdXNoKHBvcnQpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBbaW5PdXRQb3J0cywgaW5Qb3J0cywgb3V0UG9ydHNdO1xuICB9XG5cbiAgcmVtb3ZlR3JhcGgoZ3JhcGg6IGFueSkge1xuICAgIGdyYXBoLm5vZGVzLmZvckVhY2goZnVuY3Rpb24obm9kZSkge1xuICAgICAganNQbHVtYi5yZW1vdmUobm9kZS5pZCk7XG4gICAgfSk7XG4gIH1cblxuICBhZGROb2RlKCkge1xuICAgdGhpcy5kaWFsb2dTZXJ2aWNlLm9wZW4oeyB2aWV3TW9kZWw6IEFkZE5vZGVEaWFsb2cgfSkudGhlbihyZXNwb25zZSA9PiB7XG4gICAgIC8vIG5lZWQgdG8gb2J0YWluIGNvbXBvbmVudHMgdG8gcG9wdWxhdGUgZGlhbG9nXG4gICB9KTtcbiAgfVxuXG5cbiAgY3JlYXRlTGluayhzb3VyY2VFbmRQb2ludElEOiBhbnksIHRhcmdldEVuZFBvaW50SUQ6IGFueSwgbGlua0lEOiBzdHJpbmcpIHtcbiAgICBcbiAgICBpZiAoIWxpbmtJRCkgeyAgICAgXG4gICAgICB0aGlzLmRpYWxvZ1NlcnZpY2Uub3Blbih7IHZpZXdNb2RlbDogTGlua0NvbmZpZ0RpYWxvZyB9KS50aGVuKHJlc3BvbnNlID0+IHtcbiAgICAgICAgaWYgKCFyZXNwb25zZS53YXNDYW5jZWxsZWQpIHtcbiAgICAgICAgICAvLyByZW5hbWUgdGhlIGpzUGx1bWIgY29ubmVjdGlvbiBpbnN0YW5jZSB0byB0aGUgdXNlciBjaG9zZW4gbmFtZVxuICAgICAgICAgIGpzUGx1bWIuZ2V0Q29ubmVjdGlvbnMoKVtqc1BsdW1iLmdldENvbm5lY3Rpb25zKCkubGVuZ3RoIC0gMV0uaWQgPSByZXNwb25zZS5vdXRwdXQ7XG4gICAgICAgICBcbiAgICAgICAgICAvLyBlbmRwb2ludCBVVUlEcyBjb250YWluIGluZm9ybWF0aW9uIGFib3V0IHRoZSBub2RlIHRoZXkncmUgb24sIHNvIHdlIG11c3Qgc3BsaXQgdGhpcyBvdXQgIFxuICAgICAgICAgIHRoaXMubmV0d29yay5ncmFwaC5hZGRMaW5rKHJlc3BvbnNlLm91dHB1dCwge1xuICAgICAgICAgICAgZnJvbTogeyBub2RlSUQ6IHNvdXJjZUVuZFBvaW50SUQuc3BsaXQoXCItXCIpWzBdLCBwb3J0SUQ6IHNvdXJjZUVuZFBvaW50SUQuc3BsaXQoXCItXCIpWzFdIH0sXG4gICAgICAgICAgICB0bzogeyBub2RlSUQ6IHRhcmdldEVuZFBvaW50SUQuc3BsaXQoXCItXCIpWzBdLCBwb3J0SUQ6IHRhcmdldEVuZFBvaW50SUQuc3BsaXQoXCItXCIpWzFdIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBpZiBubyBJRCBpcyBwcm92aWRlZCwgcmVtb3ZlIHRoZSBjb25uZWN0aW9uXG4gICAgICAgICAgdmFyIGNvbm5lY3Rpb25zID0ganNQbHVtYi5nZXRDb25uZWN0aW9ucygpXG4gICAgICAgICAganNQbHVtYi5kZXRhY2goY29ubmVjdGlvbnNbY29ubmVjdGlvbnMubGVuZ3RoIC0gMV0pXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBlbmRwb2ludCBVVUlEcyBjb250YWluIGluZm9ybWF0aW9uIGFib3V0IHRoZSBub2RlIHRoZXkncmUgb24sIHNvIHdlIG11c3Qgc3BsaXQgdGhpcyBvdXQgIFxuICAgICAgdGhpcy5uZXR3b3JrLmdyYXBoLmFkZExpbmsobGlua0lELCB7XG4gICAgICAgIGZyb206IHsgbm9kZUlEOiBzb3VyY2VFbmRQb2ludElELnNwbGl0KFwiLVwiKVswXSwgcG9ydElEOiBzb3VyY2VFbmRQb2ludElELnNwbGl0KFwiLVwiKVsxXSB9LFxuICAgICAgICB0bzogeyBub2RlSUQ6IHRhcmdldEVuZFBvaW50SUQuc3BsaXQoXCItXCIpWzBdLCBwb3J0SUQ6IHRhcmdldEVuZFBvaW50SUQuc3BsaXQoXCItXCIpWzFdIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICAvLyByZXBlYXRlZCBjb2RlIGlzIG5lY2Vzc2FyeSwgb3RoZXJ3aXNlIHRoZSBsaW5rIHdvdWxkIGJlIGFkZGVkIGJlZm9yZSBpdCBnZXRzIHRoZSBJRCBzdXBwbGllZCBieSB0aGUgdXNlclxuICB9XG5cbiAgcmVtb3ZlTGluayhsaW5rSUQ6IHN0cmluZykgeyAgXG4gICAgdGhpcy5uZXR3b3JrLmdyYXBoLnJlbW92ZUxpbmsobGlua0lEKTtcbiAgfVxuXG4gIGNoYW5nZUxpbmsoZGF0YTogYW55KSB7IFxuICAgIHRoaXMucmVtb3ZlTGluayhkYXRhLmNvbm5lY3Rpb24uaWQpO1xuICAgIHRoaXMuY3JlYXRlTGluayhkYXRhLm9yaWdpbmFsU291cmNlRW5kcG9pbnQuZ2V0VXVpZCgpLCBkYXRhLm5ld1RhcmdldEVuZHBvaW50LmdldFV1aWQoKSwgZGF0YS5jb25uZWN0aW9uLmlkKTtcbiAgfVxuXG4gIGlzTmV3Q29ubmVjdGlvbihsaW5rSUQ6IGFueSkge1xuICAgIHZhciBpc05ldzogQm9vbGVhbjtcbiAgICB0aGlzLm5ldHdvcmsuZ3JhcGgubGlua3MuZm9yRWFjaChsaW5rID0+IHsgIFxuICAgICAgaXNOZXcgPSBsaW5rLnRvT2JqZWN0KClbXCJpZFwiXSAhPT0gbGlua0lEOyBcbiAgICB9KTtcbiAgICByZXR1cm4gaXNOZXc7XG4gIH1cblxuICBpc1pvb21lZEluKG5vZGU6IE5vZGUpIHtcbiAgICByZXR1cm4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQobm9kZS5pZCkuc3R5bGUud2lkdGggIT09IG5vZGUubWV0YWRhdGEudmlldy53aWR0aDtcbiAgfVxuXG59Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
